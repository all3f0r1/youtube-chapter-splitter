# v0.15.1 UI Fix & Filename Tests Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix the splitting UI layout and add comprehensive filename sanitization tests.

**Architecture:** Move progress bar cleanup to end of splitting function; add new UI function for completion message; create new test file for filename edge cases.

**Tech Stack:** Rust, indicatif (progress bars), regex (title sanitization)

---

## Task 1: Add `print_splitting_complete()` to UI

**Files:**
- Modify: `src/ui.rs:200` (after `print_splitting_section_header`)

**Step 1: Add the new function**

Add after `print_splitting_section_header`:

```rust
/// Display splitting completion message
pub fn print_splitting_complete() {
    println!("{} {}", "✓".bold(), "Splitting achieved");
}
```

**Step 2: Verify compilation**

Run: `cargo check`
Expected: No errors

**Step 3: Commit**

```bash
git add src/ui.rs
git commit -m "feat(ui): add print_splitting_complete function"
```

---

## Task 2: Update audio splitting to clear progress bar

**Files:**
- Modify: `src/audio.rs:143-147` (progress bar handling)

**Step 1: Update progress bar finish logic**

Replace the current `pb.finish()` at line 146 with:

```rust
    pb.finish_and_clear();
```

**Step 2: Verify compilation**

Run: `cargo check`
Expected: No errors

**Step 3: Commit**

```bash
git add src/audio.rs
git commit -m "fix(audio): clear progress bar after splitting completes"
```

---

## Task 3: Call `print_splitting_complete()` in main

**Files:**
- Modify: `src/main.rs:203-210` (after `split_audio_by_chapters` call)

**Step 1: Add completion call**

Find the section after `split_audio_by_chapters` and add the completion message:

```rust
    let _output_files = audio::split_audio_by_chapters(
        &audio_file,
        &chapters_to_use,
        &output_dir,
        &artist,
        &album,
        cover_path.as_deref(),
        Some(track_progress_callback),
    )?;

    ui::print_splitting_complete();
```

**Step 2: Verify compilation**

Run: `cargo check`
Expected: No errors

**Step 3: Commit**

```bash
git add src/main.rs
git commit -m "feat(main): call print_splitting_complete after splitting"
```

---

## Task 4: Add title case capitalization to utils

**Files:**
- Modify: `src/utils.rs` (add helper function)
- Modify: `src/utils.rs` (update `sanitize_title`)

**Step 1: Add `to_title_case` helper function**

Add after the regex definitions (around line 25):

```rust
/// Converts a string to title case (first letter of each word capitalized).
///
/// # Arguments
///
/// * `s` - The input string
///
/// # Returns
///
/// A title-cased string
fn to_title_case(s: &str) -> String {
    s.split_whitespace()
        .map(|word| {
            let mut chars = word.chars();
            match chars.next() {
                None => String::new(),
                Some(first) => first.to_uppercase().collect::<String>() + &chars.collect::<String>().to_lowercase(),
            }
        })
        .collect::<Vec<_>>()
        .join(" ")
}
```

**Step 2: Update `sanitize_title` to apply title case**

Modify `sanitize_title` function (around line 266):

```rust
pub fn sanitize_title(title: &str) -> String {
    // Remove track numbers at the beginning
    let title = RE_TRACK_PREFIX.replace(title, "");

    // Replace invalid characters
    let sanitized: String = title
        .chars()
        .map(|c| match c {
            '/' | '\\' | ':' | '*' | '?' | '"' | '<' | '>' | '|' => '_',
            _ => c,
        })
        .collect();

    // Apply title case
    to_title_case(&sanitized)
}
```

**Step 3: Verify compilation**

Run: `cargo check`
Expected: No errors

**Step 4: Commit**

```bash
git add src/utils.rs
git commit -m "feat(utils): add title case capitalization to sanitize_title"
```

---

## Task 5: Create filename sanitization test file

**Files:**
- Create: `tests/test_filename_sanitization.rs`

**Step 1: Create the test file with comprehensive tests**

```rust
//! Comprehensive tests for filename sanitization

#[cfg(test)]
mod filename_sanitization_tests {
    use youtube_chapter_splitter::utils::sanitize_title;

    // =========================================================================
    // Invalid character replacement tests
    // =========================================================================

    #[test]
    fn test_sanitize_forward_slash() {
        assert_eq!(sanitize_title("Song/Name"), "Song_Name");
    }

    #[test]
    fn test_sanitize_backslash() {
        assert_eq!(sanitize_title("Song\\Name"), "Song_Name");
    }

    #[test]
    fn test_sanitize_colon() {
        assert_eq!(sanitize_title("Song:Name"), "Song_Name");
    }

    #[test]
    fn test_sanitize_asterisk() {
        assert_eq!(sanitize_title("Song*Name"), "Song_Name");
    }

    #[test]
    fn test_sanitize_question_mark() {
        assert_eq!(sanitize_title("Song?Name"), "Song_Name");
    }

    #[test]
    fn test_sanitize_double_quote() {
        assert_eq!(sanitize_title("Song\"Name"), "Song_Name");
    }

    #[test]
    fn test_sanitize_less_than() {
        assert_eq!(sanitize_title("Song<Name"), "Song_Name");
    }

    #[test]
    fn test_sanitize_greater_than() {
        assert_eq!(sanitize_title("Song>Name"), "Song_Name");
    }

    #[test]
    fn test_sanitize_pipe() {
        assert_eq!(sanitize_title("Song|Name"), "Song_Name");
    }

    #[test]
    fn test_sanitize_all_invalid_chars() {
        assert_eq!(sanitize_title("/:*?\"<>|\\"), "_________");
    }

    #[test]
    fn test_sanitize_consecutive_invalid_chars() {
        assert_eq!(sanitize_title("Song///Name"), "Song___Name");
        assert_eq!(sanitize_title("Test:::Title"), "Test___Title");
    }

    // =========================================================================
    // Unicode preservation tests
    // =========================================================================

    #[test]
    fn test_sanitize_unicode_acute() {
        assert_eq!(sanitize_title("Café Deluxe"), "Café Deluxe");
    }

    #[test]
    fn test_sanitize_unicode_umlaut() {
        assert_eq!(sanitize_title("Björk"), "Björk");
    }

    #[test]
    fn test_sanitize_unicode_tilde() {
        assert_eq!(sanitize_title("El Niño"), "El Niño");
    }

    #[test]
    fn test_sanitize_unicode_cjk() {
        assert_eq!(sanitize_title("日本語 Title"), "日本語 Title");
    }

    #[test]
    fn test_sanitize_unicode_greek() {
        assert_eq!(sanitize_title("Ελληνικά"), "Ελληνικά");
    }

    // =========================================================================
    // Track prefix removal tests
    // =========================================================================

    #[test]
    fn test_sanitize_prefix_with_dash() {
        assert_eq!(sanitize_title("1 - Song Name"), "Song Name");
    }

    #[test]
    fn test_sanitize_prefix_with_dot() {
        assert_eq!(sanitize_title("01. Song Name"), "Song Name");
    }

    #[test]
    fn test_sanitize_prefix_track_colon() {
        assert_eq!(sanitize_title("Track 5: Song Name"), "Song Name");
    }

    #[test]
    fn test_sanitize_prefix_number_only() {
        assert_eq!(sanitize_title("1 the unholy"), "The Unholy");
    }

    #[test]
    fn test_sanitize_prefix_two_digit() {
        assert_eq!(sanitize_title("12 song title"), "Song Title");
    }

    // =========================================================================
    // Title case capitalization tests
    // =========================================================================

    #[test]
    fn test_sanitize_all_caps() {
        assert_eq!(sanitize_title("THE UNHOLY"), "The Unholy");
    }

    #[test]
    fn test_sanitize_all_lowercase() {
        assert_eq!(sanitize_title("café deluxe"), "Café Deluxe");
    }

    #[test]
    fn test_sanitize_mixed_case() {
        assert_eq!(sanitize_title("sOnG NaMe"), "Song Name");
    }

    // =========================================================================
    // Edge case tests
    // =========================================================================

    #[test]
    fn test_sanitize_empty() {
        assert_eq!(sanitize_title(""), "");
    }

    #[test]
    fn test_sanitize_whitespace_only() {
        assert_eq!(sanitize_title("   "), "");
    }

    #[test]
    fn test_sanitize_only_number() {
        assert_eq!(sanitize_title("1"), "1");
    }

    #[test]
    fn test_sanitize_only_dashes() {
        assert_eq!(sanitize_title("---"), "---");
    }

    #[test]
    fn test_sanitize_long_title() {
        let long_title = "a".repeat(300);
        let result = sanitize_title(&long_title);
        assert_eq!(result.len(), 300);
    }

    // =========================================================================
    // Mixed scenario tests
    // =========================================================================

    #[test]
    fn test_sanitize_mixed_prefix_caps_invalid() {
        assert_eq!(sanitize_title("01. CAFÉ/DELUXE: SPECIAL"), "Café_Deluxe_ Special");
    }

    #[test]
    fn test_sanitize_complex_title() {
        assert_eq!(
            sanitize_title("Track 3: THE/ANSWER:REVEALED"),
            "The_Answer_Revealed"
        );
    }
}
```

**Step 2: Run tests to verify they pass**

Run: `cargo test test_filename_sanitization`
Expected: All tests pass

**Step 3: Run all tests to ensure no regressions**

Run: `cargo test`
Expected: All tests pass

**Step 4: Commit**

```bash
git add tests/test_filename_sanitization.rs
git commit -m "test: add comprehensive filename sanitization tests"
```

---

## Task 6: Update existing sanitize_title tests

**Files:**
- Modify: `src/utils.rs` (update existing tests for new behavior)

**Step 1: Update existing tests to match new title case behavior**

Find the existing `test_sanitize_title` test (around line 337) and update:

```rust
    #[test]
    fn test_sanitize_title() {
        assert_eq!(sanitize_title("1 - Song Name"), "Song Name");
        assert_eq!(sanitize_title("Track 5: Another Song"), "Another Song");
        assert_eq!(
            sanitize_title("Invalid/Characters:Here"),
            "Invalid_Characters_Here"
        );
        // New test cases for title case
        assert_eq!(sanitize_title("THE UNHOLY"), "The Unholy");
        assert_eq!(sanitize_title("1 the unholy"), "The Unholy");
    }
```

**Step 2: Run tests to verify**

Run: `cargo test test_sanitize_title`
Expected: Tests pass

**Step 3: Commit**

```bash
git add src/utils.rs
git commit -m "test(utils): update sanitize_title tests for title case"
```

---

## Task 7: Update existing edge case tests

**Files:**
- Modify: `tests/test_utils_edge_cases.rs`

**Step 1: Update tests that expect lowercase output**

Update any tests that now expect title case:

```rust
    #[test]
    fn test_sanitize_title_all_invalid_chars() {
        let result = sanitize_title("/:*?\"<>|");
        assert_eq!(result, "________");
    }

    #[test]
    fn test_sanitize_title_unicode() {
        let result = sanitize_title("café müller");
        assert_eq!(result, "Café Müller");  // Now title case
    }

    #[test]
    fn test_sanitize_title_mixed_prefixes() {
        let result = sanitize_title("01. Track 5: Song Name");
        assert!(result.contains("Song Name"));
    }
```

**Step 2: Run tests**

Run: `cargo test test_utils_edge_cases`
Expected: Tests pass

**Step 3: Commit**

```bash
git add tests/test_utils_edge_cases.rs
git commit -m "test: update edge case tests for title case behavior"
```

---

## Task 8: Final verification and version bump

**Files:**
- Modify: `Cargo.toml` (version)

**Step 1: Run full test suite**

Run: `cargo test`
Expected: All tests pass

**Step 2: Run clippy**

Run: `cargo clippy`
Expected: No warnings

**Step 3: Bump version**

Update `Cargo.toml` version from `0.15.0` to `0.15.1`:

```toml
version = "0.15.1"
```

**Step 4: Verify build**

Run: `cargo build --release`
Expected: Build succeeds

**Step 5: Commit version bump**

```bash
git add Cargo.toml
git commit -m "chore: bump version to 0.15.1"
```

---

## Summary

| Task | Description | Files |
|------|-------------|-------|
| 1 | Add `print_splitting_complete()` | `src/ui.rs` |
| 2 | Clear progress bar after splitting | `src/audio.rs` |
| 3 | Call completion in main | `src/main.rs` |
| 4 | Add title case to sanitize | `src/utils.rs` |
| 5 | Create filename test file | `tests/test_filename_sanitization.rs` |
| 6 | Update existing utils tests | `src/utils.rs` |
| 7 | Update edge case tests | `tests/test_utils_edge_cases.rs` |
| 8 | Final verification & version bump | `Cargo.toml` |
