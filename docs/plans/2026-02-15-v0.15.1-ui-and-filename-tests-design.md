# Design: v0.15.1 — UI Fix & Filename Tests

**Date:** 2026-02-15
**Version:** 0.15.1

## Overview

Two improvements for v0.15.1:
1. **UI Fix:** Correct the splitting section layout — progress bar clears and shows success message
2. **Filename Tests:** Add comprehensive edge case tests for filename sanitization

---

## 1. UI Fix: Progress Bar with Clear

### Current Behavior (Broken)
```
▶ Splitting into 5 tracks
  ├─ 1 Cathedrals of Starlight [4m 49s]
[########>-------------------------------]                 ├─ 2 Lotus in the Ashes [4m 05s]
```
The progress bar interleaves with track names, causing visual mess.

### New Behavior (Fixed)
```
▶ Splitting into 5 tracks
  ├─ 1 Cathedrals of Starlight [4m 49s]
  ├─ 2 Lotus in the Ashes [4m 05s]
  ├─ 3 Mirage of the Self [5m 13s]
  ├─ 4 A Spark Called Now [4m 52s]
  └─ 5 A Toast to the Vanishing [4m 09s]
✓ Splitting achieved

/home/alex/Musique/Deat Dreams - Mirage Of The Self
```

The progress bar shows during processing, then is cleared and replaced by "✓ Splitting achieved".

### Implementation

**File: `src/audio.rs`**
- Progress bar remains in the loop
- After loop completes: call `pb.finish_and_clear()` to remove the bar
- Function returns normally after all tracks are processed

**File: `src/ui.rs`**
- Add `print_splitting_complete()` — prints "✓ Splitting achieved"

**File: `src/main.rs`**
- After `split_audio_by_chapters()` returns, call `ui::print_splitting_complete()`

---

## 2. Filename Sanitization Tests

### Test File: `tests/test_filename_sanitization.rs`

New comprehensive test file with ~15-20 test functions:

| Category | Test Cases |
|----------|-----------|
| **Invalid chars** | `/`, `\`, `:`, `*`, `?`, `"`, `<`, `>`, `\|` |
| **Unicode** | `Café`, `Björk`, `日本語`, `Ñoño`, `Ελληνικά` |
| **Prefix removal (with separator)** | `1 - Song`, `01. Song`, `Track 5: Song` |
| **Prefix removal (no separator)** | `1 the unholy` → `The Unholy` |
| **Capitalization** | `THE UNHOLY` → `The Unholy`, `café deluxe` → `Café Deluxe` |
| **Consecutive invalid** | `Song///Name`, `Test:::Title` |
| **Empty/edge** | `""`, `"   "`, `"1"`, `"---"` |
| **Long names** | 255+ character titles |
| **Mixed scenarios** | `01. CAFÉ/DELUXE: SPECIAL` → `Café_Deluxe_Special` |

### Potential Code Changes to `src/utils.rs`

If not already implemented, `sanitize_title()` may need updates:

1. **Number prefix without separator:** Extend regex to match `1 song` → `Song`
2. **Title case capitalization:** Add helper that capitalizes first letter of each word

---

## Files Changed

| File | Change |
|------|--------|
| `src/audio.rs` | Move progress bar clear to end of function |
| `src/ui.rs` | Add `print_splitting_complete()` |
| `src/main.rs` | Call `print_splitting_complete()` after splitting |
| `src/utils.rs` | (Optional) Add title case capitalization |
| `tests/test_filename_sanitization.rs` | New file with comprehensive tests |

---

## Success Criteria

- [ ] Progress bar no longer interleaves with track names
- [ ] "✓ Splitting achieved" appears after all tracks are listed
- [ ] All new filename tests pass
- [ ] Existing tests still pass
- [ ] `cargo clippy` passes without warnings
